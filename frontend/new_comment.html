<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/svg+xml" href="/HeadLogo.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8">
    <title>评论</title>
    <style>
        body {
            background-color: #fff5ea;
        }
    </style>

</head>
<body>
<div style="text-align:center;">
    <a href="index.html">
        <img src="public/i/Title.PNG" alt="兴趣花园" height="148" width="477" >
    </a>
</div>
<div style="text-align:center;padding-top: 60px" class="blog">

    <div class="about" style="margin:20px;height: 40px;">
        评论内容：<input type="text" name="about" id="about" style="width: 300px;height: 60px;border-radius: 3px" placeholder="请输入评论内容">
    </div><br>
    <span id="msg" style="text-align:center;font-size: 15px"></span><br><br>
    <button type="button" id="blogBin">评论</button><br><br><br>
</div>
</body>
<script type="text/javascript" src="public/jquery-3.7.1.js"></script>
<script type="text/javascript">
    $('#blogBin').click(function (){
        let about=$("#about").val();
        if(IsEmpty(about)){
            $("#msg").html("评论不可为空");
            return;
        }
        let username=localStorage.getItem('user');
        let circle=localStorage.getItem('name');
        let id=localStorage.getItem('id');
        if (username===null){
            window.location.href='login.html';
            return;
        }else{
            let count=null;
            $.ajax({
                url:"http://localhost:5173/api/create/checkpinglun",
                method:'POST',
                data:{
                    number:id,
                    circle:circle
                },
                success:function(res){
                    if(res[0].com1===null){
                        count=0;
                    }else{
                        if (res[0].com2===null){
                            count = 1;
                        }else{
                            if (res[0].com3===null){
                                count = 2;
                            }else{
                                $("#msg").html("评论已达上限");
                                return;
                            }
                        }
                    }
                    console.log(count);
                    $.ajax({
                        url:"http://localhost:5173/api/create/pinglun",
                        method:'POST',
                        data:{
                            number:id,
                            circle:circle,
                            username:username,
                            about:about,
                            count:count
                        },
                        success:function(res){
                            console.log('评论成功');
                            $("#msg").html("评论成功");
                            window.location.href='circle.html';
                        },
                        error:function (err){
                            console.log(err);
                        }
                    });
                },
                error:function (err){
                    console.log(err);
                }
            });

            $.ajax({
                //查询用户是否存在
                url:"http://localhost:5173/api/create/huoyue",
                method:'POST',
                data:{
                    username:username,
                    circle:circle
                },
                success:function(res){
                    //存在则直接加活跃，不存在则创建
                    if(res.id===0){
                        //用户不存在
                        $.ajax({
                            url:"http://localhost:5173/api/create/jiaruhuoyue",
                            method:'POST',
                            data:{
                                username:username,
                                circle:circle
                            },
                            success:function(res){
                                console.log(res);
                            },
                            error:function (err){
                                console.log(err);
                            }
                        })
                    }
                    //加活跃
                    $.ajax({
                        url:"http://localhost:5173/api/create/jingyanzhimini",
                        method:'POST',
                        data:{
                            username:username,
                            circle:circle,
                        },
                        success:function(res){
                            console.log(res);
                        },
                        error:function (err){
                            console.log(err);
                        }

                    })
                },
                error:function (err){
                    console.log(err);
                }
            });
        }
    });
    function IsEmpty(str){
        if(str==null||str.trim()== ""){
            return true;
        }
        return false;
    }
</script>
</html>